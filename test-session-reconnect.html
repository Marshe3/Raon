<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PersoAI ì„¸ì…˜ ì¬ì—°ê²° í…ŒìŠ¤íŠ¸</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    .section {
      margin: 20px 0;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      font-size: 16px;
      cursor: pointer;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 5px;
    }
    button:hover {
      background: #5568d3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .log {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      max-height: 400px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 14px;
      white-space: pre-wrap;
    }
    .success { color: green; }
    .error { color: red; }
    .info { color: blue; }
    video {
      width: 100%;
      max-width: 640px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    input {
      padding: 8px;
      font-size: 14px;
      width: 200px;
    }
  </style>
</head>
<body>
  <h1>PersoAI ì„¸ì…˜ ì¬ì—°ê²° í…ŒìŠ¤íŠ¸</h1>

  <div class="section">
    <h2>1ë‹¨ê³„: ì„¸ì…˜ ìƒì„±</h2>
    <button id="createBtn">ì„¸ì…˜ ìƒì„±</button>
    <button id="closeBtn" disabled>ì„¸ì…˜ ì¢…ë£Œ</button>
    <div>ì„¸ì…˜ ID: <strong id="sessionId">-</strong></div>
  </div>

  <div class="section">
    <h2>2ë‹¨ê³„: ì„¸ì…˜ ì¬ì—°ê²° í…ŒìŠ¤íŠ¸</h2>
    <p>ì„¸ì…˜ IDë¥¼ ì…ë ¥í•˜ê³  ì¬ì—°ê²° ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”:</p>
    <input type="text" id="reconnectInput" placeholder="ì„¸ì…˜ ID ì…ë ¥">
    <button id="reconnectBtn">ì¬ì—°ê²° ì‹œë„</button>
    <button id="checkBtn">ì„¸ì…˜ ìœ íš¨ì„± í™•ì¸</button>
  </div>

  <div class="section">
    <h2>3ë‹¨ê³„: ë©”ì‹œì§€ í…ŒìŠ¤íŠ¸</h2>
    <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ ì…ë ¥">
    <button id="sendBtn" disabled>ë©”ì‹œì§€ ì „ì†¡</button>
  </div>

  <div class="section">
    <h2>ë¹„ë””ì˜¤</h2>
    <video id="video" autoplay playsinline></video>
  </div>

  <div class="section">
    <h2>ë¡œê·¸</h2>
    <button id="clearLog">ë¡œê·¸ ì§€ìš°ê¸°</button>
    <div class="log" id="log"></div>
  </div>

  <script src="https://est-perso-live.github.io/perso-live-sdk/js/v1.0.8/perso-live-sdk.js"></script>
  <script>
    let currentSession = null;
    let currentSessionId = null;

    // ë¡œê·¸ ì¶œë ¥ í•¨ìˆ˜
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
      logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(`[${type}]`, message);
    }

    // ë°±ì—”ë“œì—ì„œ credentials ê°€ì ¸ì˜¤ê¸°
    async function getCredentials() {
      try {
        const response = await fetch('http://localhost:8086/raon/api/persoai/credentials');
        if (!response.ok) throw new Error('Credentials ë¡œë“œ ì‹¤íŒ¨');
        return await response.json();
      } catch (err) {
        log(`âŒ Credentials ë¡œë“œ ì‹¤íŒ¨: ${err.message}`, 'error');
        throw err;
      }
    }

    // ë°±ì—”ë“œë¥¼ í†µí•´ ì„¸ì…˜ ìƒì„±
    async function createSessionViaBackend() {
      try {
        log('ğŸ”„ ë°±ì—”ë“œë¡œ ì„¸ì…˜ ìƒì„± ìš”ì²­ ì¤‘...', 'info');

        const response = await fetch('http://localhost:8086/raon/api/sessions/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            promptId: 'plp-275c194ca6b8d746d6c25a0dec3c3fdb',
            llmType: 'azure-gpt-4o',
            ttsType: 'yuri',
            sttType: 'default',
            modelStyle: 'chaehee_livechat-front-white_suit-natural_loop',
            documentId: 'pld-c2104dc3d8165c42f60bcf8217c19bc8',
            backgroundImageId: null,
            agent: 1,
            paddingLeft: 0,
            paddingTop: 0,
            paddingHeight: 1
          })
        });

        if (!response.ok) throw new Error(`ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨: ${response.status}`);

        const data = await response.json();
        log(`âœ… ë°±ì—”ë“œì—ì„œ ì„¸ì…˜ ìƒì„± ì™„ë£Œ: ${data.sessionId}`, 'success');
        return data.sessionId;
      } catch (err) {
        log(`âŒ ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨: ${err.message}`, 'error');
        throw err;
      }
    }

    // SDKë¡œ WebRTC ì„¸ì…˜ ì´ˆê¸°í™”
    async function initializeSDKSession(sessionId) {
      try {
        log(`ğŸ”„ SDK ì„¸ì…˜ ì´ˆê¸°í™” ì¤‘... (ID: ${sessionId})`, 'info');

        const credentials = await getCredentials();
        const session = await window.PersoLiveSDK.createSession(
          credentials.apiServer,
          sessionId,
          1920,
          1080,
          false
        );

        session.setSrc(document.getElementById('video'));

        log(`âœ… SDK ì„¸ì…˜ ì´ˆê¸°í™” ì™„ë£Œ`, 'success');
        return session;
      } catch (err) {
        log(`âŒ SDK ì„¸ì…˜ ì´ˆê¸°í™” ì‹¤íŒ¨: ${err.message}`, 'error');
        throw err;
      }
    }

    // ì„¸ì…˜ ìœ íš¨ì„± í™•ì¸
    async function checkSession(sessionId) {
      try {
        log(`ğŸ” ì„¸ì…˜ ìœ íš¨ì„± í™•ì¸ ì¤‘... (ID: ${sessionId})`, 'info');

        const response = await fetch(`http://localhost:8086/raon/api/sessions/${sessionId}`, {
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error(`ì„¸ì…˜ ì¡°íšŒ ì‹¤íŒ¨: ${response.status}`);
        }

        const data = await response.json();
        log(`âœ… ì„¸ì…˜ì´ ìœ íš¨í•©ë‹ˆë‹¤: ${data.sessionId}`, 'success');
        return true;
      } catch (err) {
        log(`âŒ ì„¸ì…˜ì´ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ë§Œë£Œë¨: ${err.message}`, 'error');
        return false;
      }
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('createBtn').addEventListener('click', async () => {
      try {
        const sessionId = await createSessionViaBackend();
        currentSessionId = sessionId;
        document.getElementById('sessionId').textContent = sessionId;
        document.getElementById('reconnectInput').value = sessionId;

        currentSession = await initializeSDKSession(sessionId);

        // ì±„íŒ… ë¡œê·¸ êµ¬ë…
        currentSession.subscribeChatLog((chatLog) => {
          log(`ğŸ“¨ ì±„íŒ… ë¡œê·¸ ìˆ˜ì‹ : ${chatLog.length}ê°œ ë©”ì‹œì§€`, 'info');
        });

        document.getElementById('closeBtn').disabled = false;
        document.getElementById('sendBtn').disabled = false;

        log('ğŸ‰ ì„¸ì…˜ ìƒì„± ì™„ë£Œ! ì´ì œ ì„¸ì…˜ì„ ì¢…ë£Œí•˜ê³  ì¬ì—°ê²°ì„ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.', 'success');
      } catch (err) {
        log(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${err.message}`, 'error');
      }
    });

    document.getElementById('closeBtn').addEventListener('click', () => {
      if (currentSession) {
        currentSession.close();
        currentSession = null;
        log('ğŸ”´ ì„¸ì…˜ ì¢…ë£Œë¨ (ì„¸ì…˜ IDëŠ” ìœ ì§€ë¨)', 'info');
        document.getElementById('closeBtn').disabled = true;
        document.getElementById('sendBtn').disabled = true;
        log('ğŸ’¡ ì´ì œ "ì¬ì—°ê²° ì‹œë„" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì„¸ì…˜ì„ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”ì§€ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.', 'info');
      }
    });

    document.getElementById('reconnectBtn').addEventListener('click', async () => {
      const sessionId = document.getElementById('reconnectInput').value.trim();
      if (!sessionId) {
        alert('ì„¸ì…˜ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      try {
        log('', 'info');
        log('=== ì¬ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘ ===', 'info');

        // 1. ì„¸ì…˜ ìœ íš¨ì„± í™•ì¸
        const isValid = await checkSession(sessionId);
        if (!isValid) {
          log('âŒ ì¬ì—°ê²° ì‹¤íŒ¨: ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
          return;
        }

        // 2. SDKë¡œ ì¬ì—°ê²°
        currentSession = await initializeSDKSession(sessionId);
        currentSessionId = sessionId;
        document.getElementById('sessionId').textContent = sessionId;

        // ì±„íŒ… ë¡œê·¸ êµ¬ë…
        currentSession.subscribeChatLog((chatLog) => {
          log(`ğŸ“¨ ì±„íŒ… ë¡œê·¸ ìˆ˜ì‹ : ${chatLog.length}ê°œ ë©”ì‹œì§€`, 'info');
          if (chatLog.length > 0) {
            log(`ğŸ“‹ ì´ì „ ëŒ€í™” ê¸°ë¡ì´ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
          }
        });

        document.getElementById('closeBtn').disabled = false;
        document.getElementById('sendBtn').disabled = false;

        log('ğŸ‰ ì¬ì—°ê²° ì„±ê³µ! PersoAIëŠ” ì„¸ì…˜ ì¬ì‚¬ìš©ì„ ì§€ì›í•©ë‹ˆë‹¤.', 'success');
      } catch (err) {
        log(`âŒ ì¬ì—°ê²° ì‹¤íŒ¨: ${err.message}`, 'error');
      }
    });

    document.getElementById('checkBtn').addEventListener('click', async () => {
      const sessionId = document.getElementById('reconnectInput').value.trim();
      if (!sessionId) {
        alert('ì„¸ì…˜ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }
      await checkSession(sessionId);
    });

    document.getElementById('sendBtn').addEventListener('click', () => {
      const message = document.getElementById('messageInput').value.trim();
      if (!message || !currentSession) return;

      log(`ğŸ“¤ ë©”ì‹œì§€ ì „ì†¡: "${message}"`, 'info');
      currentSession.processChat(message);
      document.getElementById('messageInput').value = '';
    });

    document.getElementById('clearLog').addEventListener('click', () => {
      document.getElementById('log').innerHTML = '';
    });

    // ì´ˆê¸° ë©”ì‹œì§€
    window.addEventListener('load', () => {
      log('âœ… PersoAI SDK ë¡œë“œ ì™„ë£Œ', 'success');
      log('', 'info');
      log('ğŸ“‹ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤:', 'info');
      log('1. "ì„¸ì…˜ ìƒì„±" ë²„íŠ¼ í´ë¦­', 'info');
      log('2. ë©”ì‹œì§€ë¥¼ ëª‡ ê°œ ë³´ë‚´ì„œ ëŒ€í™” ê¸°ë¡ ìƒì„±', 'info');
      log('3. "ì„¸ì…˜ ì¢…ë£Œ" ë²„íŠ¼ í´ë¦­', 'info');
      log('4. "ì¬ì—°ê²° ì‹œë„" ë²„íŠ¼ í´ë¦­í•˜ì—¬ ê°™ì€ ì„¸ì…˜ IDë¡œ ì¬ì—°ê²°', 'info');
      log('5. ì±„íŒ… ë¡œê·¸ì— ì´ì „ ëŒ€í™” ê¸°ë¡ì´ ë³µì›ë˜ëŠ”ì§€ í™•ì¸', 'info');
      log('', 'info');
    });
  </script>
</body>
</html>
